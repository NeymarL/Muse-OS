     1                                  ; ipl
     2                                  ; TAB=4
     3                                  
     4                                  CYLS    EQU     10
     5                                  
     6                                  start:  ORG     0x7c00      ; 指明程序装载地址
     7                                  
     8                                  ; 标准FAT12格式软盘专用代码
     9                                  
    10 00000000 E94E00                          JMP     entry
    11 00000003 90                              DB      0x90
    12 00000004 48454C4C4F49504C                DB      "HELLOIPL"  ; 启动区的名称可以是任意字符串
    13 0000000C 0002                            DW      512         ; 每个扇区(sector)的大小，必须为512
    14 0000000E 01                              DB      1           ; 簇(cluster)的大小，必须为1个扇区
    15 0000000F 0100                            DW      1           ; FAT的起始位置(一般从第一个扇区开始)
    16 00000011 02                              DB      2           ; FAT的个数，必须为2
    17 00000012 E000                            DW      224         ; 根目录大小，一般设成224项
    18 00000014 400B                            DW      2880        ; 该磁盘的大小，必须是2880扇区
    19 00000016 F0                              DB      0xf0        ; 磁盘的种类，必须是0xf0
    20 00000017 0900                            DW      9           ; FAT的长度，必须是9扇区
    21 00000019 1200                            DW      18          ; 1个磁道(track)有几个扇区，必须是18
    22 0000001B 0200                            DW      2           ; 磁头数，必须是2
    23 0000001D 00000000                        DD      0           ; 不使用分区，必须是0
    24 00000021 400B0000                        DD      2880        ; 重写一次磁盘大小
    25 00000025 000029                          DB      0, 0, 0x29      ; 意义不明，固定
    26 00000028 FFFFFFFF                        DD      0xffffffff      ; 可能是卷标号码
    27 0000002C 4C495548452D4F5320-             DB      "LIUHE-OS   "   ; 磁盘的名称，11字节
    28 00000035 2020               
    29 00000037 4641543132202020                DB      "FAT12   "      ; 磁盘个是名称，8字节
    30 0000003F <res 00000012>                  RESB    18             ; 先空出18字节
    31                                  
    32                                  ; 程序主体
    33                                  
    34                                  entry:
    35                                  
    36 00000051 B80000                          MOV     AX, 0       ; 初始化寄存器
    37 00000054 8ED0                            MOV     SS, AX
    38 00000056 BC007C                          MOV     SP, 0x7c00
    39 00000059 8ED8                            MOV     DS, AX
    40                                  
    41 0000005B B82008                          MOV     AX, 0x0820
    42 0000005E 8EC0                            MOV     ES, AX
    43 00000060 B500                            MOV     CH, 0       ; 柱面0
    44 00000062 B600                            MOV     DH, 0       ; 磁头0
    45 00000064 B102                            MOV     CL, 2       ; 扇区2
    46                                  
    47                                  readloop:
    48 00000066 BE0000                          MOV     SI, 0       ; 记录失败次数
    49                                  
    50                                  retry:
    51                                  
    52 00000069 B402                            MOV     AH, 0x02    ; AH=0x02 : 读盘
    53 0000006B B001                            MOV     AL, 1       ; 1个扇区
    54 0000006D BB0000                          MOV     BX, 0
    55 00000070 B280                            MOV     DL, 0x80    ; USB驱动器
    56 00000072 CD13                            INT     0x13        ; 调用磁盘BIOS
    57 00000074 7312                            JNC     next        ; 没出错时跳转到next
    58 00000076 81C60100                        ADD     SI, 1       ; SI加一
    59 0000007A 81FE0500                        CMP     SI, 5       ; 比较SI与5
    60 0000007E 732D                            JAE     error       ; jump if above or equal
    61 00000080 B400                            MOV     AH, 0x00    ;
    62 00000082 B280                            MOV     DL, 0x80    ; USB驱动器
    63 00000084 CD13                            INT     0x13        ; 重置驱动器
    64 00000086 EBE1                            JMP     retry
    65                                  next:
    66 00000088 8CC0                            MOV     AX, ES      ; 把内存地址向后移0x200
    67 0000008A 052000                          ADD     AX, 0x0020  ; 通过AX加上0x0020, 相当于将地址后移0x200
    68 0000008D 8EC0                            MOV     ES, AX      ; 因为没有 ADD ES, 0x020指令
    69 0000008F 80C101                          ADD     CL, 1       ; sector++
    70 00000092 80F93F                          CMP     CL, 63      ; cl与63比较
    71 00000095 76CF                            JBE     readloop    ; jump if below or equal
    72                                  
    73 00000097 B101                            MOV     CL, 1
    74 00000099 80C601                          ADD     DH, 1       ; header++
    75 0000009C 80FE0A                          CMP     DH, 10
    76 0000009F 76C5                            JBE     readloop
    77                                  
    78                                          ;MOV     DH, 0
    79                                          ;ADD     CH, 1       ; cylinders++
    80                                          ;CMP     CH, CYLS
    81                                          ;JBE     readloop
    82                                  
    83                                          ;JMP     sayhello
    84 000000A1 E9(0082)                        JMP      0x8200
    85                                  
    86                                  fin:
    87 000000A4 F4                              HLT                 ; 让CPU停止，等待指令
    88 000000A5 EBFD                            JMP     fin         ; 无限循环
    89                                  
    90                                  sayhello:
    91 000000A7 BE[D200]                        MOV     SI, hello
    92 000000AA E90300                          JMP     putloop
    93                                  
    94                                  error:
    95 000000AD BE[C300]                        MOV     SI, errmsg
    96                                  
    97                                  putloop:
    98 000000B0 8A04                            MOV     AL, [SI]
    99 000000B2 81C60100                        ADD     SI, 1       ; 给SI加1
   100 000000B6 3C00                            CMP     AL, 0
   101                                  
   102 000000B8 74EA                            JE      fin
   103 000000BA B40E                            MOV     AH, 0x0e    ; 显示一个文字
   104 000000BC BB0F00                          MOV     BX, 15      ; 指定字符颜色
   105 000000BF CD10                            INT     0x10        ; 调用显卡BIOS
   106 000000C1 EBED                            JMP     putloop
   107                                  
   108                                  
   109                                  errmsg:
   110 000000C3 0A0A                            DB      0x0a, 0x0a  ; 换行两次
   111 000000C5 4C6F6164204552524F-             DB      "Load ERROR!"
   112 000000CE 5221               
   113 000000D0 0A                              DB      0x0a
   114 000000D1 00                              DB      0
   115                                  
   116                                  hello:
   117 000000D2 0A0A                            DB      0x0a, 0x0a  ; 换行两次
   118 000000D4 57656C636F6D652074-             DB      "Welcome to LIUHE-OS!"
   119 000000DD 6F204C495548452D4F-
   120 000000E6 5321               
   121 000000E8 0A                              DB      0x0a
   122 000000E9 00                              DB      0
   123                                  
   124                                  
   125 000000EA <res 00000114>          marker: RESB 0x1fe - (marker - start)  ; 填写0x00，直到0x001fe
   126 000001FE 55AA                            DB  0x55, 0xaa
   127                                  
